<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="custom/index-scroll.css" rel="stylesheet" />
		<title>地理编码</title>
		<link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css" />
		<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=31b7825c9a590b5e125e0b972fe00d9d&plugin=AMap.Geocoder"></script>
		<!--<script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>-->
		<link rel="stylesheet" type="text/css" href="css-item/component.css" />
		<link rel="stylesheet" type="text/css" href="css-item/fxsmall.css" />
		<script src="js-item/modernizr.custom.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery-1.11.1.min.js"></script>
		<script type="text/javascript" src="js/iscroll.js"></script>
		<script src="js-item/classie.js"></script>
		<script type="text/javascript" src="js/map/data.js"></script>
		<style>
			.itemDiv {
				box-shadow: 0 .1em .1em 0 rgba(0, 0, 0, .1);
				/*border: solid 1px rgba(0, 0, 0, .2);*/
				/*border-bottom: 1px solid rgba(0, 0, 0, .3);*/
				display: block;
				width: 99%;
				height: 116px;
				text-align: left;
				/*line-height: 20px;*/
				padding: 2px;
				/*margin-top: 4px;*/
			}
			
			.item-img {
				float: left;
				width: 100px;
				height: 100px;
				/*border: #6641E2 1px solid;*/
				margin-right: 5px;
			}
			
			.amap-container .item-img img {
				float: left;
				width: 100px;
				height: 100px;
				/*border: #6641E2 1px solid;*/
				margin-right: 5px;
			}
			
			.amap-logo {
				right: 0 !important;
				left: auto !important;
				display: none;
			}
			
			.amap-copyright {
				display: none;
				visibility: hidden;
			}
			
			.amap-info-close {
				font-size: 21px;
			}
		</style>
	</head>

	<body>
		<nav class="mui-bar mui-bar-tab" id='bottomx'>
			<a id="defaultTab" class="mui-tab-item" href="index.html" style='color: #619C00;'>
				<span class="mui-icon mui-icon-home"></span>
				<span class="mui-tab-label">首页</span>
			</a>
			<a class="mui-tab-item" href="faxian_main.html">
				<span class="mui-icon mui-icon-eye"></span></span>
				<span class="mui-tab-label">发现</span>
			</a>
			<a class="mui-tab-item" href="setting.html">
				<span class="mui-icon mui-icon-person"></span>
				<span class="mui-tab-label">我的</span>
			</a>
		</nav>
		<div class="wrap" style="overflow: hidden;" id="top">
			<div class="mui-row">
				<div class="mui-col-xs-2" align="left" style="padding-left: 3px;">
					<i class="point"></i>
					<label id="myla" style="cursor: pointer;text-decoration:underline">大连</label>
				</div>
				<div class="mui-col-xs-10">
					<input type="search" class="ac-pass" placeholder="输入 /污染类别/工程名称/企业名称/"></div>
				<!--<div class="mui-col-xs-1" style="line-height: 45px;" align="center">
					<a id="menu" style="line-height: 40px" class="mui-action-menu mui-icon mui-icon-bars mui-pull-right" href="#topPopover"></a>
				</div>-->
				<!--右上角弹出菜单-->
				<!--<div id="topPopover" class="mui-popover">
					<div class="mui-popover-arrow"></div>
					<div class="mui-scroll-wrapper">
						<div class="mui-scroll">
							<ul class="mui-table-view">
								<li class="mui-table-view-cell" id="postPage">
									<a href="#"><span class="mui-icon mui-icon-compose"></span>需求发布</a>
								</li>
								<li class="mui-table-view-cell">
									<a href="#">Item3</a>
								</li>

							</ul>
						</div>
					</div>

				</div>-->

			</div>
			<div id="wrapper" class="twitter_widget_1">
				<div id="scroller">
					<ul>
						<li class="testClass" id="all">
							<a href="javascript:void(0)"> 全部</a>
						</li>
						<li id="guokong"><span class="circle" style="color: #2AC845">●</span>
							<a href="javascript:void(0)">国控单元</a>
						</li>
						<li id="shikong"><span class="circle" style="color: #0062CC">●</span>
							<a href="javascript:void(0)">地控单位</a>
						</li>
						<li id="huanbao"><span class="circle" style="color: #6641E2">●</span>
							<a href="javascript:void(0)">环境企业</a>
						</li>
						<li id="rencaixuqiu"><span class="circle" style="color: #EFBF1A">●</span>
							<a href="javascript:void(0)">人才供需</a>
						</li>
						<!--<li id="gaoxiaojishu"><span class="circle" style="color: #2187E7">●</span>
							<a href="javascript:void(0)">高校技术</a>
						</li>-->
						<li id="erqi"><span class="circle" style="color: #CF2D28">●</span>
							<a href="javascript:void(0)">二期功能</a>
						</li>
					</ul>
				</div>
			</div>

			<!--<div class="mui-content">
				<a id="icon-location" onclick="getMyLacation()">
					<span class="mui-icon mui-icon-location"></span>
				</a>
				<label id="myla">点击获取当前位置</label>
			</div>-->

			<div style="width: 100%; margin-top: 92px;" id="container"></div>

			<!--<div id="container" style="height: 600px"></div>-->
			<!--<div id="tip">

			<span id="result"></span>
		</div>-->
		</div>
		<script type="text/javascript">
			var map = new AMap.Map("container", {
				resizeEnable: true
			});
			var allpoint = dalian.concat(dalian2);
			//			var icon_image = "images/map/location_all.png";
			var icon_image = new AMap.Icon({
				size: new AMap.Size(55, 35), //图标大小
				image: "images/map/location_all.png"
					//						imageOffset: new AMap.Pixel(0, -60)
			});
			mui.init({
				keyEventBind: {
					backbutton: true, //Boolean(默认true)关闭back按键监听
					menubutton: true //Boolean(默认true)关闭menu按键监听
				},
				gestureConfig: {
					swipe: true, //默认为true
				}
			})
			var first = null;
			mui.back = function() {
				if(!first) {
					first = new Date().getTime();
					mui.toast('再按一次退出应用');
					setTimeout(function() {
						first = null;
					}, 1000);
				} else {
					if(new Date().getTime() - first < 1000) {
						plus.runtime.quit();
					}
				}
			};
			$(document).ready(function() {
				var bodyHeight = $("body").height();
				var topHeight = $("#wrapper").height();
				var scrollHeight = $("#top").height();
				var mapHeight = bodyHeight - topHeight - scrollHeight;
				$("#container").height(mapHeight);
				//				mui(".mui-bar-tab a")[0].classList.add('mui-active');
				myScroll = new IScroll('#wrapper', {
					scrollX: true,
					scrollY: false,
					mouseWheel: true,
					click: true
				});
				document.addEventListener('touchmove', function(e) {
					e.preventDefault();
				}, false);
				$("#scroller a").click(function() {
					var city = $("#myla").html();
					switch(city) {
						case '大连':
							var CityData = dalian;
							break;
						case '沈阳':
							var CityData = Shenyang;
							break;
						case '鞍山':
							var CityData = Anshan;
							break;
						case '朝阳':
							var CityData = Chaoyang;
							break;
						case '抚顺':
							var CityData = Fushun;
							break;
						case '盘锦':
							var CityData = Panjin;
							break;
						case '辽阳':
							var CityData = Liaoyang;
							break;

					}

					$("#scroller li").removeClass('testClass');
					$(this).parent('li').addClass('testClass');
					var str = $(this).parent('li').attr("id");
					map = new AMap.Map("container", {
						resizeEnable: true
					});
					switch(str) {
						case 'all':
							icon_image = new AMap.Icon({
								size: new AMap.Size(55, 35), //图标大小
								image: "images/map/location_all.png"
							});
							geocoder(CityData);
							break;
						case 'guokong':
							icon_image = new AMap.Icon({
								size: new AMap.Size(55, 35), //图标大小
								image: "images/map/icon-04.png"
							});
							geocoder(CityData);
							break;
						case 'shikong':
							icon_image = new AMap.Icon({
								size: new AMap.Size(55, 35), //图标大小
								image: "images/map/icon-05.png"
							});
							geocoder(CityData);
							break;
						case 'huanbao':
							icon_image = new AMap.Icon({
								size: new AMap.Size(55, 35), //图标大小
								image: "images/map/icon-07.png"
							});
							geocoder(CityData);
							break;
						case 'rencaixuqiu':
							icon_image = new AMap.Icon({
								size: new AMap.Size(55, 35), //图标大小
								image: "images/map/icon-03.png"
							});
							geocoder(CityData);
							break;
					}
				});

				geocoder(allpoint);
				$(".point").click(function() {
					var cityList = mui.openWindow({
						url: 'cityList.html',
						id: "cityList.html",
						createNew: false
					});
					mui.fire(cityList, 'show', {
						gpsCity: gpsCity,
					});
					cityList.show("slide-in-top", 350);
				});
				mui('#postPage').on('tap', 'a', function(e) {
					var postPage = mui.openWindow({
						url: 'post.html',
						id: "post.html",
						createNew: false
					});
					mui.fire(postPage, 'show', {
						theLocationX: longitude,
						theLocationY: latitude
					});
					postPage.show();
				});
				layoutHeight = $(window).height();

				$(window).resize(function() {
					clientHeight = $(window).height();
					changeHeight = layoutHeight - clientHeight;
					if(changeHeight > 100) {
						$("#bottomx").hide();
						$(".ac-pass").unbind("keypress").bind('keypress', function(event) {
							event = document.all ? window.event : event;
							if((event.keyCode || event.which) == 13) {
								//								alert("点击搜索");
								var inputStr = $.trim($(".ac-pass").val());
								if($("#myla").html() != "大连") {
									alert("该区域未搜索到此检索条件，切换城市到<大连>");
									$("#myla").html("大连");
								}
								$("#scroller li").removeClass('testClass');
								$("#all").addClass('testClass');
								icon_image = new AMap.Icon({
									size: new AMap.Size(55, 35), //图标大小
									image: "images/map/location_all.png"
								});
								map = new AMap.Map("container", {
									resizeEnable: true
								});
								switch(inputStr) {
									case "工业污水":
										var CityData = search;
										geocoder(CityData);
										break;
									case "雪花":
										var CityData = search1;
										geocoder(CityData);
										break;
									case "大气污染":
										var CityData = dalian2;
										geocoder(CityData);
										break;
									default:
										alert("该区域未搜索到此检索条件");
								}
								$(".ac-pass").blur();
							}
						});
					} else {
						$("#bottomx").show();
						$(".ac-pass").unbind("keypress");
					}
				});
			});

			var longitude = "";
			var latitude = "";
			mui.plusReady(function() {
				//				plus.navigator.closeSplashscreen();
				plus.geolocation.getCurrentPosition(function(p) {
					var lnglatXY = [121.618622, 38.91459]; //已知点坐标
					//					regeocoder(lnglatXY);
					var geocoder = new AMap.Geocoder({
						radius: 1000,
						extensions: "all"
					});
					geocoder.getAddress(lnglatXY, function(status, result) {
						if(status === 'complete' && result.info === 'OK') {
							gpsCity = result.regeocode.addressComponent.city //返回地址描述
						}
					});
				}, function(e) {
					alert("Geolocation error: " + e.message);
				});

				window.addEventListener('show', function(event) {
					//获得事件参数  
					var city = event.detail.city;
					$("#myla").html(city);
					$(".ac-pass").val('');
					switch(city) {
						case '大连':
							var CityData = dalian;
							break;
						case '沈阳':
							var CityData = Shenyang;
							break;
						case '鞍山':
							var CityData = Anshan;
							break;
						case '朝阳':
							var CityData = Chaoyang;
							break;
						case '抚顺':
							var CityData = Fushun;
							break;
						case '盘锦':
							var CityData = Panjin;
							break;
						case '辽阳':
							var CityData = Liaoyang;
							break;

					}

					var itemStr = $(".testClass").attr("id");
					map = new AMap.Map("container", {
						resizeEnable: true
					});
					switch(itemStr) {
						case 'all':
							icon_image = new AMap.Icon({
								size: new AMap.Size(55, 35), //图标大小
								image: "images/map/location_all.png"
							});
							break;
						case 'guokong':
							icon_image = new AMap.Icon({
								size: new AMap.Size(55, 35), //图标大小
								image: "images/map/icon-04.png"
							});
							break;
						case 'shikong':
							icon_image = new AMap.Icon({
								size: new AMap.Size(55, 35), //图标大小
								image: "images/map/icon-05.png"
							});
							break;
						case 'huanbao':
							icon_image = new AMap.Icon({
								size: new AMap.Size(55, 35), //图标大小
								image: "images/map/icon-07.png"
							});
							break;
						case 'rencaixuqiu':
							icon_image = new AMap.Icon({
								size: new AMap.Size(55, 35), //图标大小
								image: "images/map/icon-03.png"
							});
							break;
					}
					geocoder(CityData);
				})

				mui('.mui-bar-tab').on('tap', 'a', function(e) {
					var targetTab = this.getAttribute('href');
					if(targetTab == "index.html") {
						return;
					}
					// 在Android5以上设备，如果默认没有开启硬件加速，则强制设置开启
					if(!plus.webview.defaultHardwareAccelerated() && parseInt(plus.os.version) >= 5) {
						styles.hardwareAccelerated = true;
					}
					if(targetTab == "faxian_main.html") {
						var faxianPage = mui.openWindow({
							url: 'faxian_main.html',
							id: "faxian_main.html",
							createNew: false
						});
						faxianPage.show("fade-in");
					}
					if(targetTab == "setting.html") {
						var settingPage = mui.openWindow({
							url: 'setting.html',
							id: "setting.html",
							createNew: false
						});
						settingPage.show("fade-in");
					}
				});
			})

			function geocoder(point) {
				var geocoder = new AMap.Geocoder({
					city: $("#myla").html(), //城市，默认：“全国”
					radius: 500 //范围，默认：500
				});

				for(key in point) {
					var add = point[key];
					//地理编码,返回地理编码结果
					geocoder.getLocation(add, function(status, result) {
						if(status === 'complete' && result.info === 'OK') {
							geocoder_CallBack(result);
						}
					});
					//					geocodeSearch1(add, key, point);
				}

			}

			function addMarker(i, d) {
				var marker = new AMap.Marker({
					map: map,
					position: [d.location.getLng(), d.location.getLat()],
					icon: icon_image
				});
				var str = "<div class='itemDiv'>";
				str = str + "<div class='item-img'>";
				str = str + "<img src = 'images/map/aitejpg.jpg'/>";
				str = str + "</div>";
				str = str + "<h4 style='font-size:15px'>";
				str = str + "<span class='mui-badge mui-badge-danger' style='font-size:15px;'>土壤</span>";
				str = str + "<a href='info.html'>" + d.formattedAddress + "</a>";
				str = str + "</h4>";
				//				str = str + "<p style='text-align:left'>"
				str = str + "<span class='mui-badge'>简介</span>";
				str = str + "XXX有限公司成立于2003年，公司位于大连开发区双D港，占地17000平方米。";
				//				str = str + "<p/>";
				str = str + "</div>";
				var infoWindow = new AMap.InfoWindow({
					content: str,
					offset: {
						x: 0,
						y: -30
					}
				});
				marker.on("click", function(e) {
					infoWindow.open(map, marker.getPosition());
				});
			}
			//地理编码返回结果展示
			function geocoder_CallBack(data) {
				var resultStr = "";
				//地理编码结果数组
				var geocode = data.geocodes;
				for(var i = 0; i < geocode.length; i++) {
					//拼接输出html
					//					resultStr += "<span style=\"font-size: 12px;padding:0px 0 4px 2px; border-bottom:1px solid #C1FFC1;\">" + "<b>地址</b>：" + geocode[i].formattedAddress + "" + "&nbsp;&nbsp;<b>的地理编码结果是:</b><b>&nbsp;&nbsp;&nbsp;&nbsp;坐标</b>：" + geocode[i].location.getLng() + ", " + geocode[i].location.getLat() + "" + "<b>&nbsp;&nbsp;&nbsp;&nbsp;匹配级别</b>：" + geocode[i].level + "</span>";
					addMarker(i, geocode[i]);
				}
				map.setFitView();
				//				document.getElementById("result").innerHTML = resultStr;
			}
		</script>
	</body>

</html>